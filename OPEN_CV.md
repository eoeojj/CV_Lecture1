# OPEN CV

## 1. 컴퓨터 비전(CV)와 영상의 이해

### 1.1 컴퓨터 비전 개요

   **컴퓨터 비전(CV=computer vision)**이란, 사람이 눈을 통하여 사물을 인지하는 것을 컴퓨터가 동영상이나 정지 영상을 보고 필요한 데이터를 알고리즘을 통해 얻는 것이다. 

사람이 사물을 인식하는 것은 쉽지만 컴퓨터가 사물을 인식하기 위해서는 이미지에서의 밝기 모양 색상 텍스쳐(texture)등 정보와 머신러닝(machine learning)알고리즘을 활용하여야 한다. 또한 영상 데이터에는 다양한 변형이 있을 수 있기 때문에 복합적인 방법으로 정보를 사용해야한다.

컴퓨터 비전과 더불어 영상처리(image processing)이 있다. 영상처리는 컴퓨터 비전과 비슷하다. 명확히 구분하기는 어렵지만 영상에서 정보를 얻어내기 위해 전처리를 해서 영상의 질을 높이는 것이라 볼 수 있다.

컴퓨터 비전은 **1960년대 **컴퓨터 보급이 이루어지고 인공위성으로부터 전송받은 달 사진표면의 잡음을 제거하는 작업을 시초라 말하기도 하고 **1970**년대 카메라의 이미지를 컴퓨터가 인식하도록 한 것을 시초라고 말하기도 한다. **70년대부터 90년대**에는 기본적인 영상 특징 분석에서 고수준 연구(움직임 정보, 3차원 구조 ,얼굴 인식)를 진행하였다. **2000년대**에는 실시간, 특징점 분석 및 매칭으로 기술개발로 실생활에 연관있는 기술이 발전되었다. **2010년대**에 들어서는 딥러닝(deep learning)기술이 발전하면서 활용 영역이 많이 늘어났다.

*딥러닝 - 인공신경망에 빅데이터를 결합한 것으로 컴퓨터가 스스로 빅데이터에서 패턴을 찾아내어 분류하는 것이다. 

컴퓨터비전관련 분야 지식도 중요한데 신호처리, 패턴인식, 머신러닝, 컴퓨터과학(수치 해석, 알고리즘, 최적화),인지과학(이해하는 방식 연구), 컴퓨터그래픽스(영상 분석을 자연스럽게 재구성), 로봇공학분야가 있다. 그 중 수학이 굉장히 중요하다. 특히 행렬 미분 개념은 필수적으로 알고 있어야 한다. Open CV는 라이브러리가 C++ 언어로 구현되어있다. C++문법 중 클래스와 상속관계, STL, C++11/14/17을 잘 알아야한다.

*STL(Standard Template Library) - 표준템플릿 라이브러리 이다. 임의 타입의 객체를 보관하는 컨테이너(container), 컨테이너에 보관된 원소에 접근할 수 있는 반복자(iterator), 반복자들을가지고 일련의 작업을 수행하는 알고리즘(algorithm)등 으로 구성되어있다.

*C++11/14/17 - C++의 개발형 11 : mordern, 14 : minor, 17 : major 버전이다.

컴퓨터 비전으로 영상의 화질 개선 및 공장에서 머신 비전으로 사람보다 빠르고 정확하게 동작할 수 있게 한다.

### 1.2 영상의 구조와 표현 방법

영상 생성 과정, 픽셀값 표현 방법

#### 1.2.1 영상의 획득과 표현방법

영상은 피사체 $\rightarrow$렌즈$\rightarrow$ 이미지 센서$\rightarrow$ ISP 를 거쳐 영상 파일 형식으로 저장된다. 이 2차원 영상을 구성하는 최소단위는 픽셀(pixel=화소)이다. 픽셀은 격자형태로 배열되어 나타난다. 픽셀 좌표는 가로  x축 세로 y축으로 영상을 f라고표기 후 영상의 좌표픽셀값은 f(x,y)로 표현한다. 

영상의 좌표픽셀값은 2차원 행렬로 나타낼 수 있다.

#### 1.2.2 그레이스케일 영상(grayscale image)과 트루컬러 영상(true color image)

CV에서 주로 사용하는 영상이다. 

그레이스케일은 흑백(밝기정보)로 구성되어있고 밝기정보를 256(0~255)단계로 구분한다. 0이 어두운 색 255는 밝은색이다. 그레이스케일값은 보통 unsigned char 자료형을 사용한다. 자료형값을 재정의해서 쓰는 경우가 많은데 이 책에서는 typedef unsigned char uchar 을 활용하여 uchar자료형을 이용한다. 밝은 부분은 큰 그레이스케일러 값을 가지고 어두운 부분은 반대로 낮은 스케일러 값을 가진다. 

트루컬러영상은 다양한 색을 구성하고 있다. R,G,B 색의 조합으로 영상을 표현한다. 각 색상은 (0~225)사이의 정수값 조합으로 픽셀값을 정한다. (r,g,b)순으로 표현한다. 

## 2. OpenCV 설치와 기초 사용법

### 2.1 OpenCV 개요와 설치

OpenCV 라이브러리의 특징 역사 모듈 소개

#### 2.1.1 OpenCV 개요

Open Source Computer Vision Library 의 약어이다. 오픈소스코드로 상업적이용이 가능하고 BSD라이선스를 따르고 있기 때문에 자유롭게 이용이 가능하다. 영상을 다루는 라이브러리, 머신 러닝 알고리즘, 딥러닝의 심층 신경망 모델 실행 기능 등을 제공한다. 또한 다양한 컴퓨터 언어, 다양한 운영체제, 모바일로도 개발 가능하다. 그로인해 다양한 대기업과 스타트업회사에서는 OpenCV를 활용한다.

##### OpenCV 역사

1999년 intel 에서 개발된 IPL(Image primitive Library)를 기반으로 만들어지기 시작했다. 현재 OpenCV4.0은 c++11/14/17을 지원하고 DNN지원을 강화했다. 

*DNN-딥러닝 심층신경망

##### OpenCV 모듈

OpenCV는 다수의 모듈로 구성되어있다. 여기서 모듈은 각 함수를 기능,성격에 따라서 분류한 라이브러리를 말한다. 모듈을 쓰기위해 하나씩 포함시키는 것이 번거로워서 world모듈을 만들어 여러개의 모듈을 통합해서 OpenCV 의 모든 기능을 사용할 수 있게 했다. world모듈은 opencv_world410.lib 와 opencv_world40.dll 파일로 만들어진다. 모듈은 현재까지도 업데이트 되고있으며 그 모듈은 추가 모듈 형태로 개발된다. 이는 깃허브 opencv_contrib 저장소의 소스코드에서 직접 가져와 쓸 수 있다. 

#### 2.1.2 OpenCV 설치하기

공식 사이트에서 OpenCV 최신버전인 4.1.0을 설치하기로 한다. 일단 <https://github.com/opencv/opencv/releases>다음 사이트에서 opencv-4.1.0-vc14_vc15.exe를 다운로드 받는다. 환경변수 설정까지 완료하면 설치완료이다.

### 2.2 OpenCV 사용하기

프로젝트 생성, 화면출력하기

visual studio 2017을 이용하여 OpenCV 응용 프로그램을 만든다. window 데스크톱 마법사로 응용프로그램 프로젝트를 생성. 

#### OpenCV 주요 함수

```
Mat imread(const String& filename , int flags = IMREAD_COLOR);
```

filename : 불러올 영상 파일 이름

flags : 영상 파일 불러오기 옵션플래그 , ImreadModes 열거형 상수 지정

반환값 : 불러온 영상데이처 (Mat 개체)

=> filename 영상파일을 불러와서 Mat객체로 변환하여 반환한다. : 쉽게 영상을 호출하는 함수라고 생각하면 된다. 열거형 상수를 사용하여 다양한 기능을 쓸 수 있다.

```
bool imwrite(const String& filename, InputArray img, const std::vector<int>& params = std::vector<int>( ));
```

filename : 불러올 영상 파일 이름

img : 저장할 영상 데이터(Mat 객체)

params : 저장할 영상 파일 형식에 의존적인 파라미터(플래그&값) 쌍, 영상의 별도 옵션을 지정할 수 있다. JPEG압축률을 나타내는 코드인 IMWRITE_JEPG_QUALITY를 활용하여 압축률 조정이 가능하다. 파일 형식 변경. 옵션설정

반환값 : 정상적으로 저장하면 true, 실패하면 false를 반환한다. 

=>img 변수에 저장되어 있는 영상 데이터를 filename 이름의 파일로 저장한다. : 영상데이터를 파일로 저장하기 위해서 사용하는 함수이다. 

```
bool Mat::empty( ) const
```

반환값 : 행렬의 rows 또는 cols 멤버 변수가 0이거나, 또는 data 멤버변수가 NULL이면 true 를 반환한다.

=>Mat::empty()을 이용하여 객체가 잘 생성되었는지 확인한다. 

```
void nameWindow(const String& winname, int flags = WINDOW_AUTOSIZE);
```

winname : 영상출력 창 이름 이 '고유한 문자열'로 창을 구분한다

flags : 창의 속성 지정 플래그, WindowFlags 열거형 상수 지정. 인자를 지정하지 않으면 WINDOW_AUTOSIZE로 자동으로 영상크기에 맞춰서 창이 생성된다. 창의 사이즈를 resizeWindow()함수를 이용하여 변경하거나 마우스로 변경하고 싶다면 값은WINDOW_NORMAL로 지정해야한다. 

=>영상 출력을 하기 위해 빈 창 생성하는 함수

```
void destroyWindow(const String& winname);
void destroyAllWindow();
```

winname : 소멸시킬 창 이름

=>영상 출력 창을 닫는 함수. 프로그램이 종료 될 때 창은 자동으로 닫히지만 동작 중에 창을 닫고 싶다면 이 함수를 반드시 사용해야 한다.

```
void moveWindow(const String& winname, int x, int y);
```

winname : 위치를 이동할 창 이름

x , y: 창이 이동할 x, y좌표 

=>출력창을 정해진 위치로 이동시킨다.

```
void resizeWindow(const String& winname, int width, int height);
```

winname : 위치를 이동할 창 이름

width, height : 각각 창의 가로, 세로 크기

=>프로그램 동작 중에 출력 창의 크기를 바꿀 때 쓰이는 함수이다. 창의 전체크기가 아닌 영상이 나오는 부분의 크기를 바꾼다. WINDOW_AUTOSIZE 플래그로 설정되었던 창이라면 이 함수로 크기를 변경할 수 없다.

```
void imshow(const String& winname, InputArray mat);
```

winname : 영상 출력할 창 이름

mat : 출력할 영상 데이터(Mat 객체)

-1채널 8비트 ucahr =픽셀값 그레이스케일 밝기형태

-3채널 컬러 = 색상표현 B G R 순서의 배열로 넣어야 한다

-16 . 32비트 정수형=행렬원소값/256 :영상의 밝기값

-16 . 32비트 실수형=행렬원소값*255:영상의 밝기값

=>Mat 클래스 객체에 저장된 영상데이터를 화면에 출력하는 함수이다.  InputArray 타입은 대부분 Mat클래스 타입의 변수를 전달한다고 생각해도 된다. 이 함수가 호출되는 시점에 출력창이 없어도 자동으로  WINDOW_AUTOSIZE속성의 창이 만들어진다.

```
int waitKey(int delay=0);
```

delay : 키 입력을 기다리는 시간 ms 단위delay<=이면 무한으로 기다린다.

반환값 : 눌린 키 값 안눌렸으면 -1반환

=>키보드를 입력 받는 용도로 사용된다. imshow()를 호출 한 후 waitKey() 함수 호출해야 영상이 정상적으로 출력된다.



